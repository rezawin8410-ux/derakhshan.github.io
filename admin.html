<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>پنل پست‌گذاری حرفه‌ای – درخشان</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<!-- 1️⃣ TinyMCE 6 -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"></script>
<!-- 2️⃣ Toast-UI Markdown -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<!-- 3️⃣ CodeMirror 6 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.0.1/codemirror.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.0.1/codemirror.min.js"></script>
<!-- 4️⃣ GrapesJS -->
<link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
<script src="https://unpkg.com/grapesjs"></script>
<!-- 5️⃣ RunJS (ساده‌سازی امن) -->
<script src="https://cdn.jsdelivr.net/npm/safe-eval@0.4.1/safe-eval.min.js"></script>
<!-- 6️⃣ Embed.js -->
<script src="https://cdn.jsdelivr.net/npm/embed-js@5.0.0/dist/embed.min.js"></script>
<!-- 7️⃣ Prism.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<!-- 8️⃣ Plyr.js -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<script src="https://cdn.plyr.io/3.7.8/plyr.min.js"></script>
<!-- 9️⃣ KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<style>
body{font-family:Tahoma;background:#f5f5f5;margin:0;padding:0}
.section{background:#fff;border-radius:12px;padding:25px;margin:25px 0;box-shadow:0 4px 12px rgba(0,0,0,.1)}
h2{color:#00bfa5;margin-bottom:15px}
#editorContainer{min-height:400px;border:1px solid #ddd;border-radius:8px}
</style>
</head>
<body>
<div class="container-fluid mt-4">
  <h1 class="text-center mb-4">پنل پست‌گذاری حرفه‌ای – درخشان</h1>

  <!-- LOGIN -->
  <div id="loginBox" class="text-center" style="max-width:400px;margin:auto">
    <input type="password" id="pass" class="form-control mb-2" placeholder="رمز عبور">
    <button class="btn btn-success w-100" onclick="login()">ورود</button>
    <p id="msg" class="text-danger mt-2"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="d-none">
    <!-- ساخت / ویرایش پست -->
    <div class="section">
      <input type="hidden" id="postId">
      <input id="postTitle" class="form-control mb-2" placeholder="عنوان پست">
      <select id="editorType" class="form-select mb-2" onchange="switchEditor()">
        <option value="tinymce">TinyMCE</option>
        <option value="markdown">Toast-UI Markdown</option>
        <option value="code">CodeMirror</option>
        <option value="grapes">GrapesJS Builder</option>
      </select>
      <div id="editorContainer"></div>
      <textarea id="customHead" class="form-control mt-2" rows="2" placeholder="کد دلخواه Head این پست"></textarea>
      <textarea id="customFoot" class="form-control mt-2" rows="2" placeholder="کد دلخواه Footer این پست"></textarea>
      <button class="btn btn-primary mt-2" onclick="savePost()">ذخیره پست</button>
    </div>

    <!-- لیست پست‌ها -->
    <div class="section">
      <h2>پست‌های موجود</h2>
      <div id="postsList"></div>
    </div>

    <!-- بک‌آپ -->
    <div class="section">
      <button class="btn btn-success" onclick="exportFull()">دانلود بک‌آپ</button>
      <input type="file" accept=".json" onchange="importFull(event)" class="form-control mt-2">
    </div>
  </div>
</div>

<script>
const PASSWORD='admin1234';
/* ---------- LOGIN ---------- */
function login(){
  if(document.getElementById('pass').value===PASSWORD){
    localStorage.setItem('isAdmin','true');
    document.getElementById('loginBox').classList.add('d-none');
    document.getElementById('panel').classList.remove('d-none');
    initEditors();
    loadPosts();
  }else{
    document.getElementById('msg').textContent='رمز اشتباه است';
  }
}
if(localStorage.getItem('isAdmin')==='true'){
  login();
}

/* ---------- TinyMCE ---------- */
let tinyInstance, mdInstance, cmInstance, grapesInstance;
function initEditors(){
  /* TinyMCE */
  if(!tinyInstance){
    tinymce.init({
      selector:'#editorContainer',
      plugins:'advlist autolink lists link image media table preview code',
      toolbar:'undo redo | bold italic | bullist numlist | link image media | preview code',
      language:'fa',
      height:400,
      setup:ed=>tinyInstance=ed
    });
  }
  /* Toast-UI Markdown */
  if(!mdInstance){
    mdInstance=new toastui.Editor({
      el:document.getElementById('editorContainer'),
      previewStyle:'vertical',
      height:'400px',
      initialEditType:'markdown',
      language:'fa'
    });
  }
  /* CodeMirror */
  if(!cmInstance){
    cmInstance=CodeMirror(document.getElementById('editorContainer'),{
      mode:'htmlmixed',
      theme:'default',
      lineNumbers:true,
      autofocus:true
    });
  }
  /* GrapesJS */
  if(!grapesInstance){
    grapesInstance=grapes.init({
      container:'#editorContainer',
      height:'400px',
      fromElement:false,
      storageManager:{type:'none'},
      panels:{defaults:[]}
    });
  }
}

/* ---------- Switch Editor ---------- */
function switchEditor(){
  const type=document.getElementById('editorType').value;
  document.getElementById('editorContainer').innerHTML='';
  if(type==='tinymce'){
    initEditors(); tinyInstance.show();
  }else if(type==='markdown'){
    initEditors(); mdInstance.show();
  }else if(type==='code'){
    initEditors(); cmInstance.refresh();
  }else if(type==='grapes'){
    initEditors(); grapesInstance.render();
  }
}

/* ---------- Save Post ---------- */
function generateId(){return Date.now().toString(36);}
function savePost(){
  const id=document.getElementById('postId').value || generateId();
  const editorType=document.getElementById('editorType').value;
  let content='';
  if(editorType==='tinymce') content=tinyInstance.getContent();
  else if(editorType==='markdown') content=mdInstance.getMarkdown();
  else if(editorType==='code') content=cmInstance.getValue();
  else if(editorType==='grapes') content=grapesInstance.getHtml();
  const post={
    id,
    title:document.getElementById('postTitle').value,
    content,
    editorType,
    customHead:document.getElementById('customHead').value,
    customFoot:document.getElementById('customFoot').value,
    created:new Date().toLocaleString('fa-IR')
  };
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const idx=posts.findIndex(p=>p.id===id);
  if(idx>-1) posts[idx]=post; else posts.push(post);
  localStorage.setItem('posts',JSON.stringify(posts));
  alert('ذخیره شد');
  loadPosts();
}

/* ---------- Load Posts ---------- */
function loadPosts(){
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const list=document.getElementById('postsList'); list.innerHTML='';
  posts.forEach(p=>{
    list.innerHTML+=`
      <div class="border p-2 mb-2">
        <strong>${p.title}</strong> (${p.editorType})
        <button class="btn btn-sm btn-warning" onclick="editPost('${p.id}')">ویرایش</button>
        <button class="btn btn-sm btn-danger" onclick="deletePost('${p.id}')">حذف</button>
      </div>`;
  });
}
function editPost(id){
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const p=posts.find(x=>x.id===id);
  document.getElementById('postId').value=p.id;
  document.getElementById('postTitle').value=p.title;
  document.getElementById('editorType').value=p.editorType;
  switchEditor();
  setTimeout(()=>{
    if(p.editorType==='tinymce') tinyInstance.setContent(p.content);
    else if(p.editorType==='markdown') mdInstance.setMarkdown(p.content);
    else if(p.editorType==='code') cmInstance.setValue(p.content);
    else if(p.editorType==='grapes') grapesInstance.setComponents(p.content);
  },300);
  document.getElementById('customHead').value=p.customHead||'';
  document.getElementById('customFoot').value=p.customFoot||'';
}
function deletePost(id){
  if(!confirm('حذف شود؟')) return;
  const posts=JSON.parse(localStorage.getItem('posts')||'[]').filter(p=>p.id!==id);
  localStorage.setItem('posts',JSON.stringify(posts));
  loadPosts();
}

/* ---------- Backup ---------- */
function exportFull(){
  const keys=['posts','log'];
  const data=Object.fromEntries(keys.map(k=>[k,JSON.parse(localStorage.getItem(k))||[]]));
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='full_backup.json'; a.click();
}
function importFull(e){
  const file=e.target.files[0];
  if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    const data=JSON.parse(ev.target.result);
    Object.keys(data).forEach(k=>localStorage.setItem(k,JSON.stringify(data[k])));
    loadPosts();
    alert('بازگردانی شد');
  };
  r.readAsText(file);
}
</script>
</body>
</html>

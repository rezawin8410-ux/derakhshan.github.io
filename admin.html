<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>پنل پست‌گذاری یکپارچه – درخشان</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
<style>
:root{--primary:#00bfa5;--accent:#ff6f00;--bg:#f5f5f5}
body{font-family:Tahoma;background:var(--bg);margin:0}
.section{background:#fff;border-radius:12px;padding:25px;margin:25px 0;box-shadow:0 4px 12px rgba(0,0,0,.1)}
h2{color:var(--primary);margin-bottom:15px}
#editorText{width:100%;min-height:200px;border:1px solid #ccc;border-radius:8px;padding:10px;font-family:inherit}
#previewDIV{background:#f9f9f9;border:1px dashed #ccc;border-radius:8px;padding:15px;margin-top:10px}
#previewDIV img{max-width:100%;border-radius:6px;margin:5px 0}
.toolbar button{margin:2px}
.modal-body input, .modal-body textarea{width:100%;margin-bottom:10px}
@media (max-width:576px){.section{padding:15px}}
</style>
</head>
<body>
<div class="container-fluid mt-4">
  <h1 class="text-center mb-4">پنل پست‌گذاری یکپارچه – درخشان</h1>

  <!-- LOGIN -->
  <div id="loginBox" class="text-center" style="max-width:400px;margin:auto">
    <input type="password" id="pass" class="form-control mb-2" placeholder="رمز عبور">
    <button class="btn btn-success w-100" onclick="login()">ورود</button>
    <p id="msg" class="text-danger mt-2"></p>
  </div>

  <!-- PANEL -->
  <div id="panel" class="d-none">
    <div class="section">
      <input type="hidden" id="postId">
      <input id="postTitle" class="form-control mb-2" placeholder="عنوان پست">

      <!-- Toolbar -->
      <div class="toolbar mb-2">
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('**','**')">B</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('*','*')">I</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('<span style=\'color:red;\'>','</span>')">قرمز</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('<span style=\'color:blue;\'>','</span>')">آبی</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('<div class=\'text-start\'>','</div>')">چپ</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('<div class=\'text-center\'>','</div>')">وسط</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="wrapText('<div class=\'text-end\'>','</div>')">راست</button>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#imageModal">عکس</button>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#codeModal">کد</button>
        <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#formulaModal">فرمول</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">پیش‌نمایش</button>
      </div>

      <textarea id="editorText" placeholder="محتوا (متن، تصویر، کد، فرمول و …)"></textarea>

      <div id="previewDIV" style="display:none;"></div>

      <textarea id="customHead" class="form-control mt-2" rows="2" placeholder="کد دلخواه Head این پست"></textarea>
      <textarea id="customFoot" class="form-control mt-2" rows="2" placeholder="کد دلخواه Footer این پست"></textarea>
      <button class="btn btn-primary mt-2" onclick="savePost()">ذخیره پست</button>
    </div>

    <div class="section">
      <h2>پست‌های موجود</h2>
      <div id="postsList"></div>
    </div>

    <div class="section">
      <button class="btn btn-success" onclick="exportFull()">دانلود بک‌آپ</button>
      <input type="file" accept=".json" onchange="importFull(event)" class="form-control mt-2">
    </div>
  </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">افزودن عکس</div>
      <div class="modal-body">
        <input type="text" id="imgUrl" placeholder="آدرس عکس">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="insertImage()">افزودن</button>
      </div>
    </div>
  </div>
</div>

<!-- Code Modal -->
<div class="modal fade" id="codeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">افزودن کد</div>
      <div class="modal-body">
        <textarea id="codeInput" rows="4" placeholder="کد را اینجا وارد کنید"></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="insertCode()">افزودن</button>
      </div>
    </div>
  </div>
</div>

<!-- Formula Modal -->
<div class="modal fade" id="formulaModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">افزودن فرمول LaTeX</div>
      <div class="modal-body">
        <input type="text" id="formulaInput" placeholder="مثلاً x^2 + y^2">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="insertFormula()">افزودن</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const PASSWORD='admin1234';
function login(){
  if(document.getElementById('pass').value===PASSWORD){
    localStorage.setItem('isAdmin','true');
    document.getElementById('loginBox').classList.add('d-none');
    document.getElementById('panel').classList.remove('d-none');
    loadPosts();
  }else{
    document.getElementById('msg').textContent='رمز اشتباه است';
  }
}
if(localStorage.getItem('isAdmin')==='true'){
  document.getElementById('loginBox').classList.add('d-none');
  document.getElementById('panel').classList.remove('d-none');
  loadPosts();
}

function wrapText(before, after){
  const el=document.getElementById('editorText');
  const start=el.selectionStart;
  const end=el.selectionEnd;
  const selected=el.value.substring(start,end);
  const newText=el.value.substring(0,start)+before+selected+after+el.value.substring(end);
  el.value=newText;
  el.focus();
}

function insertImage(){
  const url=document.getElementById('imgUrl').value;
  if(!url) return;
  document.getElementById('editorText').value+=`<img src="${url}" class="img-fluid">`;
  bootstrap.Modal.getInstance(document.getElementById('imageModal')).hide();
  document.getElementById('imgUrl').value='';
}
function insertCode(){
  const code=document.getElementById('codeInput').value;
  if(!code) return;
  document.getElementById('editorText').value+=`<pre><code>${code}</code></pre>`;
  bootstrap.Modal.getInstance(document.getElementById('codeModal')).hide();
  document.getElementById('codeInput').value='';
}
function insertFormula(){
  const formula=document.getElementById('formulaInput').value;
  if(!formula) return;
  document.getElementById('editorText').value+=`<span class="katex">${formula}</span>`;
  bootstrap.Modal.getInstance(document.getElementById('formulaModal')).hide();
  document.getElementById('formulaInput').value='';
}

function togglePreview(){
  const preview=document.getElementById('previewDIV');
  preview.style.display=preview.style.display==='none'?'block':'none';
  preview.innerHTML=document.getElementById('editorText').value;
}

/* ذخیره و بازیابی */
function generateId(){return Date.now().toString(36);}
function savePost(){
  const id=document.getElementById('postId').value || generateId();
  const post={
    id,
    title:document.getElementById('postTitle').value,
    content:document.getElementById('editorText').value,
    customHead:document.getElementById('customHead').value,
    customFoot:document.getElementById('customFoot').value,
    created:new Date().toLocaleString('fa-IR')
  };
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const idx=posts.findIndex(p=>p.id===id);
  if(idx>-1) posts[idx]=post; else posts.push(post);
  localStorage.setItem('posts',JSON.stringify(posts));
  alert('ذخیره شد');
  document.getElementById('postId').value='';
  document.getElementById('postTitle').value='';
  document.getElementById('editorText').value='';
  document.getElementById('customHead').value='';
  document.getElementById('customFoot').value='';
  loadPosts();
}
function loadPosts(){
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const list=document.getElementById('postsList'); list.innerHTML='';
  posts.forEach(p=>{
    list.innerHTML+=`
      <div class="border p-2 mb-2">
        <strong>${p.title}</strong>
        <button class="btn btn-sm btn-warning" onclick="editPost('${p.id}')">ویرایش</button>
        <button class="btn btn-sm btn-danger" onclick="deletePost('${p.id}')">حذف</button>
      </div>`;
  });
}
function editPost(id){
  const posts=JSON.parse(localStorage.getItem('posts')||'[]');
  const p=posts.find(x=>x.id===id);
  document.getElementById('postId').value=p.id;
  document.getElementById('postTitle').value=p.title;
  document.getElementById('editorText').value=p.content;
  document.getElementById('customHead').value=p.customHead||'';
  document.getElementById('customFoot').value=p.customFoot||'';
}
function deletePost(id){
  if(!confirm('حذف شود؟')) return;
  const posts=JSON.parse(localStorage.getItem('posts')||'[]').filter(p=>p.id!==id);
  localStorage.setItem('posts',JSON.stringify(posts));
  loadPosts();
}
function exportFull(){
  const data={posts:JSON.parse(localStorage.getItem('posts')||'[]')};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='posts_backup.json'; a.click();
}
function importFull(e){
  const file=e.target.files[0];
  if(!file) return;
  const r=new FileReader();
  r.onload=ev=>{
    const data=JSON.parse(ev.target.result);
    localStorage.setItem('posts',JSON.stringify(data.posts||[]));
    loadPosts();
    alert('بازگردانی شد');
  };
  r.readAsText(file);
}
</script>
</body>
</html>
